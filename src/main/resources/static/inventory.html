<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Thông tin kho hàng</title>
    <style>
        :root {
            --primary: #1976d2;
            --primary-light: #e3f2fd;
            --border: #e0e0e0;
            --bg: #fafafa;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1180px;
            margin: 20px auto;
            background: var(--bg);
        }

        h1 {
            margin: 0 0 20px 0;
            font-size: 28px;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px 20px;
            background: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
            margin-bottom: 18px;
        }

        h2 {
            margin-top: 0;
            margin-bottom: 6px;
        }

        p.sub {
            margin-top: 0;
            color: #666;
            font-size: 13px;
        }

        label {
            display: block;
            margin-top: 8px;
            margin-bottom: 4px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"] {
            width: 220px;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        button {
            padding: 6px 14px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 6px;
            border: 1px solid var(--primary);
            background: var(--primary);
            color: #fff;
            font-size: 13px;
        }
        button:hover {
            background: #125aa0;
        }
        button.secondary {
            background: #fff;
            color: var(--primary);
        }
        button.secondary:hover {
            background: var(--primary-light);
        }

        .result {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            background: #f8f8f8;
            font-family: Consolas, monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        /* layout danh sách + chart */
        .inventory-layout {
            display: grid;
            grid-template-columns: 1.6fr 1.1fr;
            grid-gap: 20px;
            align-items: flex-start;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 13px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
        }
        th {
            background: #f5f5f5;
        }
        tbody tr:nth-child(even) {
            background: #fafafa;
        }
        tbody tr:hover {
            background: #e3f2fd;
        }

        .row-low {
            background: #fff3e0 !important;  /* cam nhạt */
        }
        .row-critical {
            background: #ffebee !important;  /* đỏ nhạt */
        }

        .tag-stock {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: bold;
        }
        .stock-ok {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .stock-low {
            background: #fff3cd;
            color: #856404;
        }
        .stock-critical {
            background: #ffebee;
            color: #c62828;
        }

        /* chart */
        .chart-card-title {
            margin-top: 0;
            margin-bottom: 4px;
        }
        .chart-wrapper {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fcfcfc;
            padding: 10px 12px;
        }
        #inventoryChart {
            font-size: 12px;
        }
        .chart-empty {
            font-style: italic;
            color: #777;
        }

        .chart-columns {
            height: 240px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 14px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            padding: 0 20px;
        }
        .chart-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 46px;
            height: 100%;
        }
        .chart-bar-container {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .chart-bar {
            width: 100%;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            position: relative;
        }
        .chart-bar-value {
            position: absolute;
            top: -18px;
            font-size: 11px;
            padding: 2px 4px;
            border-radius: 4px;
            background: #ffffffcc;
        }
        .chart-col-label {
            margin-top: 4px;
            font-weight: bold;
            font-size: 11px;
        }
        .chart-legend {
            text-align: center;
            font-size: 11px;
            color: #555;
        }
        .chart-bar {
            width: 100%;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            position: relative;
            border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 0 6px rgba(0,0,0,0.35);
        }

        .chart-bar.ok {
            background: linear-gradient(180deg, #4caf50, #1b5e20);
        }
        .chart-bar.medium {
            background: linear-gradient(180deg, #ffa000, #e65100);
        }
        .chart-bar.low {
            background: linear-gradient(180deg, #e53935, #b71c1c);
        }

        .chart-bar-value {
            position: absolute;
            bottom: 4px;
            font-size: 11px;
            padding: 2px 4px;
            border-radius: 4px;
            color: #fff;
            background: rgba(0,0,0,0.25);
        }
    </style>
</head>
<body>

<div class="page-header">
    <h1>Thông tin kho hàng</h1>
</div>

<!-- Thêm / cập nhật -->
<div class="card">
    <h2>Thêm / cập nhật kho</h2>
    <p class="sub">Nếu <b>productId</b> đã tồn tại, thao tác <b>Thêm</b> sẽ set lại số lượng mới.</p>
    <input id="newProductId" type="text" placeholder="Mã sản phẩm (vd: P001)" />
    <input id="newQuantity" type="number" min="0" value="0" />
    <button onclick="createInventory()">Thêm</button>

    <div id="info" class="result"></div>
</div>

<!-- Danh sách + biểu đồ -->
<div class="card">
    <h2>Danh sách kho & biểu đồ</h2>
    <button class="secondary" onclick="loadInventory()">Tải danh sách kho</button>

    <div class="inventory-layout">
        <!-- Bảng -->
        <div>
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Mã sản phẩm</th>
                    <th>Số lượng tồn</th>
                    <th>Hành động</th>
                </tr>
                </thead>
                <tbody id="inventoryTableBody">
                <tr><td colspan="4">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Biểu đồ -->
        <div>
            <h3 class="chart-card-title">Trạng thái kho </h3>
            <div class="chart-wrapper">
                <div id="inventoryChart" class="chart-empty">
                    Chưa có dữ liệu. Hãy bấm "Tải danh sách kho".
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ====== LOAD DANH SÁCH + VẼ BIỂU ĐỒ ======
    async function loadInventory() {
        const tbody = document.getElementById('inventoryTableBody');
        tbody.innerHTML = '<tr><td colspan="4">Đang tải...</td></tr>';

        try {
            const res = await fetch('/inventory');
            if (!res.ok) {
                tbody.innerHTML = '<tr><td colspan="4">Lỗi: ' + res.status + '</td></tr>';
                renderInventoryChart([]);
                return;
            }

            const data = await res.json();

            if (!Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Chưa có dữ liệu kho.</td></tr>';
                renderInventoryChart([]);
                return;
            }

            tbody.innerHTML = '';
            data.forEach(inv => {
                const tr = document.createElement('tr');

                // Phân loại mức tồn kho theo %:
                //  >50%: ok, 20–50: low, <20: critical (so với max)
                // -> tạm thời đánh dấu class, lát nữa dùng max trong chart
                tr.dataset.qty = inv.quantity;

                tr.innerHTML =
                    '<td>' + inv.id + '</td>' +
                    '<td>' + inv.productId + '</td>' +
                    '<td>' + renderStockCell(inv.quantity) + '</td>' +
                    '<td>' +
                        '<button class="secondary" onclick="editInventory('
                        + inv.id + ', \'' + inv.productId + '\',' + inv.quantity + ')">Sửa</button> ' +
                        '<button class="secondary" onclick="deleteInventory(' + inv.id + ')">Xoá</button>' +
                    '</td>';
                tbody.appendChild(tr);
            });

            // Gán màu nền theo mức tồn kho, dựa trên max
            decorateRowsByStock();

            // Vẽ biểu đồ
            renderInventoryChart(data);
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="4">Exception: ' + e + '</td></tr>';
            renderInventoryChart([]);
        }
    }

    function renderStockCell(qty) {
        let cls = 'stock-ok';
        let text = qty;

        // class chỉ để màu tag
        return '<span class="tag-stock ' + cls + '">' + text + '</span>';
    }

    function decorateRowsByStock() {
        const rows = Array.from(document.querySelectorAll('#inventoryTableBody tr'));
        if (rows.length === 0) return;

        const quantities = rows
            .map(r => parseInt(r.dataset.qty, 10))
            .filter(q => !isNaN(q));
        if (quantities.length === 0) return;

        const max = Math.max(...quantities, 1);

        rows.forEach(r => {
            const q = parseInt(r.dataset.qty, 10) || 0;
            const pct = (q / max) * 100;

            r.classList.remove('row-low', 'row-critical');

            if (pct === 0) {
                r.classList.add('row-critical');
            } else if (pct <= 20) {
                r.classList.add('row-critical');
            } else if (pct <= 50) {
                r.classList.add('row-low');
            }
        });
    }

    // ====== BIỂU ĐỒ CỘT ======
function renderInventoryChart(items) {
    const container = document.getElementById('inventoryChart');

    if (!items || items.length === 0) {
        container.className = 'chart-empty';
        container.textContent = 'Chưa có dữ liệu kho để hiển thị biểu đồ.';
        return;
    }

    const quantities = items.map(i => i.quantity || 0);
    const maxQty = Math.max(...quantities);
    if (maxQty === 0) {
        container.className = 'chart-empty';
        container.textContent = 'Tất cả sản phẩm đều có số lượng = 0.';
        return;
    }

    // nén sqrt để cột không quá chênh lệch
    const scaledValues = quantities.map(q => Math.sqrt(q));
    const maxScaled = Math.max(...scaledValues);

    container.className = '';
    let html = '<div class="chart-columns">';

    items.forEach((inv, idx) => {
        const qty = quantities[idx];
        const scaled = scaledValues[idx];

        // chiều cao (%)
        let percent = Math.round((scaled / maxScaled) * 100);
        const height = Math.max(percent, 15); // tối thiểu 15%

        // màu theo % lượng gốc
        const pctOriginal = (qty / maxQty) * 100;
        let levelClass = 'ok';      // xanh
        if (pctOriginal <= 20) {
            levelClass = 'low';     // đỏ
        } else if (pctOriginal <= 50) {
            levelClass = 'medium';  // cam
        }

        html +=
        '<div class="chart-col">' +
            '<div class="chart-bar-container">' +
                '<div class="chart-bar ' + levelClass + '" style="height:' + height + '%">' +
                    '<span class="chart-bar-value">' + qty + '</span>' +
                '</div>' +
            '</div>' +
            '<div class="chart-col-label">' + inv.productId + '</div>' +
        '</div>';
    });

    html += '</div>';
    html += '<div class="chart-legend">' +
        'Màu cột: xanh = tồn kho tốt, cam = trung bình, đỏ = thấp (so với sản phẩm nhiều nhất).' +
        '</div>';

    container.innerHTML = html;
    }

    // ====== CRUD ======
    async function createInventory() {
        const productId = document.getElementById('newProductId').value.trim();
        const quantity = parseInt(document.getElementById('newQuantity').value, 10);
        const info = document.getElementById('info');

        if (!productId) {
            info.textContent = 'Vui lòng nhập mã sản phẩm';
            return;
        }

        try {
            const res = await fetch('/inventory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId, quantity })
            });

            if (!res.ok) {
                const text = await res.text();
                info.textContent = 'Lỗi: ' + res.status + ' - ' + text;
                return;
            }

            const data = await res.json();
            info.textContent = 'Đã lưu kho: ' + JSON.stringify(data, null, 2);
            loadInventory();
        } catch (e) {
            info.textContent = 'Exception: ' + e;
        }
    }

    async function editInventory(id, currentProductId, currentQuantity) {
        const newProductId = prompt('Mã sản phẩm mới:', currentProductId);
        if (newProductId === null) return;

        const qtyStr = prompt('Số lượng mới:', currentQuantity);
        if (qtyStr === null) return;

        const quantity = parseInt(qtyStr, 10);
        if (Number.isNaN(quantity) || quantity < 0) {
            alert('Số lượng không hợp lệ');
            return;
        }

        try {
            const res = await fetch('/inventory/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ productId: newProductId, quantity })
            });

            if (!res.ok) {
                const text = await res.text();
                alert('Lỗi cập nhật: ' + res.status + ' - ' + text);
                return;
            }

            loadInventory();
        } catch (e) {
            alert('Exception: ' + e);
        }
    }

    async function deleteInventory(id) {
        if (!confirm('Bạn có chắc muốn xoá dòng kho ID = ' + id + ' ?')) {
            return;
        }

        try {
            const res = await fetch('/inventory/' + id, {
                method: 'DELETE'
            });

            if (!res.ok && res.status !== 204) {
                const text = await res.text();
                alert('Lỗi xoá: ' + res.status + ' - ' + text);
                return;
            }

            loadInventory();
        } catch (e) {
            alert('Exception: ' + e);
        }
    }

    // load lần đầu
    window.addEventListener('load', loadInventory);
</script>

</body>
</html>
