<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống đặt hàng (RabbitMQ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 CSS -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
        }
        .result-box {
            margin-top: 10px;
            padding: 8px;
            background: #f8f8f8;
            border-radius: 6px;
            font-family: Consolas, monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .badge-yes {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .badge-no {
            background: #ffebee;
            color: #c62828;
        }
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-ok   { color: #2e7d32; }
        .status-error{ color: #c62828; }
        .status-pending{ color: #856404; }

        /* cho bảng cuộn ngang trên màn hình nhỏ */
        .table-responsive {
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="container my-4">
    <h1 class="mb-4 text-center text-md-start">Hệ thống đặt hàng (RabbitMQ)</h1>

    <!-- Hàng 1: Tạo đơn + Thống kê -->
    <div class="row g-3 mb-3">
        <!-- Tạo đơn hàng -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Tạo đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label for="customerName" class="form-label">
                            Họ tên khách hàng <span class="text-danger">*</span>
                        </label>
                        <input id="customerName" type="text"
                               class="form-control"
                               placeholder="VD: Hùng" required>
                    </div>

                    <div class="mb-2">
                        <label for="productId" class="form-label">
                            Mã sản phẩm <span class="text-danger">*</span>
                        </label>
                        <input id="productId" type="text"
                               class="form-control"
                               placeholder="VD: P001" required>
                    </div>

                    <div class="mb-2">
                        <label for="quantity" class="form-label">Số lượng</label>
                        <input id="quantity" type="number" min="1" value="1"
                               class="form-control">
                    </div>

                    <div class="mb-2">
                        <label for="totalPrice" class="form-label">Tổng tiền</label>
                        <input id="totalPrice" type="number" min="0" value="0"
                               class="form-control">
                    </div>

                    <button class="btn btn-primary" onclick="createOrder()">Tạo đơn</button>

                    <div id="createOrderResult" class="result-box mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Thống kê đơn hàng -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Thống kê đơn hàng</h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadOrderStats()">
                        Tải thống kê
                    </button>
                </div>
                <div class="card-body">
                    <details class="mb-2">
                        <summary>Hiện / ẩn JSON thống kê</summary>
                        <div id="statsJson" class="result-box mt-2"></div>
                    </details>

                    <div class="row g-2">
                        <div class="col-6 col-lg-3">
                            <div class="border rounded-3 text-center p-2 bg-light">
                                <div class="small text-muted">Tổng số đơn</div>
                                <div id="totalOrdersValue" class="fw-bold fs-4">0</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="border rounded-3 text-center p-2 bg-light">
                                <div class="small text-muted">Đã xử lý nền xong</div>
                                <div id="processedOrdersValue" class="fw-bold fs-4">0</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="border rounded-3 text-center p-2 bg-light">
                                <div class="small text-muted">Đang chờ xử lý</div>
                                <div id="pendingOrdersValue" class="fw-bold fs-4">0</div>
                            </div>
                        </div>
                        <div class="col-6 col-lg-3">
                            <div class="border rounded-3 text-center p-2 bg-light">
                                <div class="small text-muted">Lỗi cập nhật kho</div>
                                <div id="failedOrdersValue" class="fw-bold fs-4">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hàng 2: Tra cứu trạng thái -->
    <div class="row g-3 mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Tra cứu trạng thái đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2 align-items-end">
                        <div class="col-sm-6 col-md-4">
                            <label for="statusOrderId" class="form-label">Order ID</label>
                            <input id="statusOrderId" type="number" min="1"
                                   placeholder="Nhập ID đơn hàng"
                                   class="form-control">
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-primary mt-2 mt-sm-0"
                                    onclick="checkOrderStatus()">
                                Xem trạng thái
                            </button>
                        </div>
                    </div>

                    <div id="orderStatusResult" class="result-box mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hàng 3: Danh sách đơn -->
    <div class="row g-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh sách đơn hàng</h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadOrders()">
                        Tải danh sách đơn
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Khách</th>
                                <th>SP</th>
                                <th>SL</th>
                                <th>Tổng tiền</th>
                                <th>Trạng thái</th>
                                <th>Email</th>
                                <th>Kho</th>
                                <th>Log</th>
                                <th>Huỷ</th>
                            </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                            <tr><td colspan="10" class="text-center">
                                Chưa có dữ liệu. Bấm "Tải danh sách đơn".
                            </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS (tùy chọn, cho dropdown/modal… – layout không bắt buộc) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ======= Helpers =======
    function renderBadge(ok) {
        if (ok === true) {
            return '<span class="badge badge-yes">OK</span>';
        }
        if (ok === false) {
            return '<span class="badge badge-no">Lỗi</span>';
        }
        return '<span class="badge badge-pending">N/A</span>';
    }

    function computeStatus(order) {
        const email = !!order.emailSent;
        const stock = !!order.stockUpdated;
        const log = !!order.logWritten;

        if (email && stock && log) {
            return { text: 'Hoàn tất', className: 'badge badge-yes' };
        }
        if (email && log && !stock) {
            return { text: 'Lỗi kho', className: 'badge badge-no' };
        }
        return { text: 'Đang xử lý', className: 'badge badge-pending' };
    }

    // ======= Tạo đơn hàng =======
    async function createOrder() {
        const customerNameInput = document.getElementById('customerName');
        const productIdInput = document.getElementById('productId');
        const quantityInput = document.getElementById('quantity');
        const totalPriceInput = document.getElementById('totalPrice');
        const resultEl = document.getElementById('createOrderResult');

        const customerName = customerNameInput.value.trim();
        const productId = productIdInput.value.trim();
        const quantity = parseInt(quantityInput.value, 10);
        const totalPrice = parseFloat(totalPriceInput.value);

        resultEl.textContent = '';

        if (!customerName) {
            resultEl.textContent = 'Vui lòng nhập Họ tên khách hàng.';
            customerNameInput.focus();
            return;
        }
        if (!productId) {
            resultEl.textContent = 'Vui lòng nhập Mã sản phẩm.';
            productIdInput.focus();
            return;
        }
        if (!quantity || quantity <= 0) {
            resultEl.textContent = 'Số lượng phải lớn hơn 0.';
            quantityInput.focus();
            return;
        }

        try {
            const res = await fetch('/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customerName, productId, quantity, totalPrice })
            });

            if (!res.ok) {
                const text = await res.text();
                resultEl.textContent = 'Lỗi: ' + res.status + ' - ' + text;
                return;
            }

            const data = await res.json();
            resultEl.textContent = JSON.stringify(data, null, 2);

            loadOrders();
            setTimeout(loadOrderStats, 300);
        } catch (e) {
            resultEl.textContent = 'Exception: ' + e;
        }
    }

    // ======= Danh sách đơn =======
    async function loadOrders() {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Đang tải...</td></tr>';

        try {
            const res = await fetch('/orders');
            if (!res.ok) {
                tbody.innerHTML =
                    '<tr><td colspan="10" class="text-center">Lỗi: ' + res.status + '</td></tr>';
                return;
            }

            const data = await res.json();

            if (!Array.isArray(data) || data.length === 0) {
                tbody.innerHTML =
                    '<tr><td colspan="10" class="text-center">Chưa có đơn hàng.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            data.forEach(o => {
                const tr = document.createElement('tr');
                const status = computeStatus(o);
                const khoBadge = o.stockUpdated === false
                    ? '<span class="badge badge-no">Lỗi</span>'
                    : renderBadge(o.stockUpdated);

                tr.innerHTML =
                    '<td>' + o.id + '</td>' +
                    '<td>' + (o.customerName || '') + '</td>' +
                    '<td>' + (o.productId || '') + '</td>' +
                    '<td>' + o.quantity + '</td>' +
                    '<td>' + o.totalPrice + '</td>' +
                    '<td><span class="' + status.className + '">' + status.text + '</span></td>' +
                    '<td>' + renderBadge(o.emailSent) + '</td>' +
                    '<td>' + khoBadge + '</td>' +
                    '<td>' + renderBadge(o.logWritten) + '</td>' +
                    '<td>' +
                    (o.cancelled
                        ? '<span class="badge badge-pending">Đã huỷ</span>'
                        : '<button class="btn btn-sm btn-outline-danger" onclick="cancelOrder(' + o.id + ')">Huỷ</button>'
                    ) +
                    '</td>';

                tbody.appendChild(tr);
            });
        } catch (e) {
            tbody.innerHTML =
                '<tr><td colspan="10" class="text-center">Exception: ' + e + '</td></tr>';
        }
    }

    // ======= Thống kê đơn =======
    async function loadOrderStats() {
        const statsJsonEl = document.getElementById('statsJson');
        const totalEl = document.getElementById('totalOrdersValue');
        const processedEl = document.getElementById('processedOrdersValue');
        const pendingEl = document.getElementById('pendingOrdersValue');
        const failedEl = document.getElementById('failedOrdersValue');

        statsJsonEl.textContent = 'Đang tải...';

        try {
            const res = await fetch('/orders/stats');
            if (!res.ok) {
                const text = await res.text();
                statsJsonEl.textContent = 'Lỗi: ' + res.status + ' - ' + text;
                return;
            }

            const stats = await res.json();
            statsJsonEl.textContent = JSON.stringify(stats, null, 2);

            totalEl.textContent = stats.totalOrders ?? 0;
            processedEl.textContent = stats.processedOrders ?? 0;
            pendingEl.textContent = stats.pendingOrders ?? 0;
            failedEl.textContent = stats.failedOrders ?? 0;
        } catch (e) {
            statsJsonEl.textContent = 'Exception: ' + e;
        }
    }

    // ======= Tra cứu trạng thái đơn hàng =======
    async function checkOrderStatus() {
        const id = document.getElementById('statusOrderId').value;
        const resultEl = document.getElementById('orderStatusResult');

        if (!id) {
            resultEl.textContent = 'Vui lòng nhập ID đơn hàng.';
            return;
        }

        try {
            const res = await fetch('/orders/' + id + '/status');
            if (!res.ok) {
                const text = await res.text();
                resultEl.innerHTML =
                    '<span class="status-error">Lỗi: ' + res.status + ' - ' + text + '</span>';
                return;
            }

            const data = await res.json();

            const status = computeStatus({
                emailSent: data.emailSent,
                stockUpdated: data.stockUpdated,
                logWritten: data.logWritten
            });

            let html = '';
            html += '<div><strong>Đơn #' + data.orderId + '</strong> - ' +
                '<span class="' + status.className + '">' + status.text + '</span></div>';

            if (status.text === 'Hoàn tất') {
                html += '<div class="status-ok">Đơn hàng đã được xử lý xong.</div>';
            } else if (status.text === 'Lỗi kho' && data.stockUpdated === false) {
                html += '<div class="status-error">Nguyên nhân: không cập nhật được kho (có thể do tồn kho không đủ).</div>';
            } else {
                html += '<div class="status-pending">Đơn hàng đang được xử lý nền. Vui lòng kiểm tra lại sau.</div>';
            }

            html += '<div class="mt-2">';
            html += '<strong>Chi tiết:</strong><br>';
            html += 'Email: ' + renderBadge(data.emailSent) + '<br>';
            html += 'Kho: ' + (data.stockUpdated === false
                ? '<span class="badge badge-no">Lỗi</span>'
                : renderBadge(data.stockUpdated)) + '<br>';
            html += 'Log: ' + renderBadge(data.logWritten) + '<br>';
            html += '</div>';

            resultEl.innerHTML = html;
        } catch (e) {
            resultEl.innerHTML = '<span class="status-error">Exception: ' + e + '</span>';
        }
    }

    // ======= Huỷ đơn =======
    async function cancelOrder(id) {
        if (!confirm('Bạn có chắc muốn huỷ đơn #' + id + ' ?')) return;

        try {
            const res = await fetch('/orders/' + id + '/cancel', { method: 'POST' });
            if (!res.ok) {
                const text = await res.text();
                alert('Lỗi huỷ đơn: ' + res.status + ' - ' + text);
                return;
            }
            alert('Đã huỷ đơn #' + id);
            loadOrders();
            setTimeout(loadOrderStats, 300);
        } catch (e) {
            alert('Exception: ' + e);
        }
    }

    // Tự load lần đầu
    window.addEventListener('load', () => {
        loadOrders();
        loadOrderStats();
    });
</script>
</body>
</html>
